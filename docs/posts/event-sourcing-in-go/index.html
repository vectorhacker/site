<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="I&amp;rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&amp;rsquo;ve been doing it in Go and want to share how I do it.
To begin with, I&amp;rsquo;ve researched this topic thoroughly; I&amp;rsquo;ve probably watched and re-watched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://victoramartinez.com/posts/event-sourcing-in-go/" />


    <title>
        
            Event Sourcing in Go :: Victor&#39;s Personal Blog  â€” Ramblings of a Software Professional
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.84ed5579024525d4b50458514d1a43e40dd5272df45c7cd6da85b225af457154.css">




<meta itemprop="name" content="Event Sourcing in Go">
<meta itemprop="description" content="I&rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&rsquo;ve been doing it in Go and want to share how I do it.
To begin with, I&rsquo;ve researched this topic thoroughly; I&rsquo;ve probably watched and re-watched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it.">
<meta itemprop="datePublished" content="2020-03-23T21:13:59-04:00" />
<meta itemprop="dateModified" content="2020-03-23T21:13:59-04:00" />
<meta itemprop="wordCount" content="2341">
<meta itemprop="image" content="https://victoramartinez.com/"/>



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://victoramartinez.com/"/>

<meta name="twitter:title" content="Event Sourcing in Go"/>
<meta name="twitter:description" content="I&rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&rsquo;ve been doing it in Go and want to share how I do it.
To begin with, I&rsquo;ve researched this topic thoroughly; I&rsquo;ve probably watched and re-watched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it."/>
<meta name="twitter:site" content="@https://www.twitter.com/vectorhacker"/>





    <meta property="article:published_time" content="2020-03-23 21:13:59 -0400 AST" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://victoramartinez.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">hello</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://victoramartinez.com/about/">About</a></li><li><a href="https://victoramartinez.com/posts">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>11 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://victoramartinez.com/posts/event-sourcing-in-go/">Event Sourcing in Go</a>
            </h1>

            

            <div class="post-content">
                <p>I&rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&rsquo;ve been doing it in Go and want to share how I do it.</p>
<p>To begin with, I&rsquo;ve researched this topic thoroughly; I&rsquo;ve probably watched and re-watched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it. The first thing I want to put out there is that you don&rsquo;t need a framework to do this. Ddd and cqrs/es are best done without a framework getting in the way and instead you should create a <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Clean Architecture</a> where the framework you choose later on becomes a sort of plugin into your application.</p>
<p>So what is &ldquo;event sourcing&rdquo;? Simply put, event sourcing is a pattern by which the current state is derived from previous facts (events). That is to say, to get the current state of an object you replay all the events of an object in memory to rebuild it from the actions you took previously. And you must accept these previous actions as fact, that is they already happened and you can&rsquo;t change it. You can change your mind about what a fact means to you in the future, but you can&rsquo;t change the fact or that it happened. New events are emitted when new actions are taken and that gets saved into the event store. The only unit of persistence in an event-sourced application is the events, everything else is a projection of those events or more correctly a cache.</p>
<p>Events are emitted by aggregates who are composed of one or more entities. The repository for those aggregates is responsible for saving those events into the event store.</p>
<p>Where do these events come from? They come from the initial design of the system through various exercises such as event storming, a process by which the overall process or sub-process of an application is discovered and modeled as events that have happened. Keep in mind, these aren&rsquo;t fine-grained low-level events like you might be used to in GUI programming, such as a user clicked event, they&rsquo;re more coarse than that. Take the example of a system that deals with hospital admissions of a patient, let us model the interactions the patient has in the system with events. A patient might first be admitted into the hospital, we might say we have a &ldquo;Patient Admitted&rdquo; event; notice the past perfect tense. Later on, when a patient is transferred to another ward we say that we have a &ldquo;Patient Transferred&rdquo; event. Finally, when a patient gets discharged we have &ldquo;Patient Discharged&rdquo;. These events arose out of the need to describe what has happened to a patient.</p>
<p>These events are created through the use of commands in the command query responsibility segregation pattern. Commands signify intent that an action should be taken, but with no guarantee that they will. A command handler can reject commands and produce no events. There are many ways to model commands in a system. They can be as simple as imperative methods that tell an object what to do or as DTOs that have the data in them needed to carry out the command. In my case, I chose to make it as simple as a method on an object.</p>
<p>So with all this, what does it all look like in Go? To begin let&rsquo;s look at what an event might look like in Go. Let&rsquo;s use our patient example.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">patient</span>

<span style="color:#75715e">// Event is a domain event marker.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Event</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">isEvent</span>()
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">PatientAdmitted</span>) <span style="color:#a6e22e">isEvent</span>()    {}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">PatientTransferred</span>) <span style="color:#a6e22e">isEvent</span>() {}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">PatientDischarged</span>) <span style="color:#a6e22e">isEvent</span>() {}

<span style="color:#75715e">// PatientAdmitted event.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PatientAdmitted</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span>   <span style="color:#a6e22e">ID</span>         <span style="color:#e6db74">`json:&#34;id&#34;`</span>
	<span style="color:#a6e22e">Name</span> <span style="color:#a6e22e">Name</span>       <span style="color:#e6db74">`json:&#34;name&#34;`</span>
	<span style="color:#a6e22e">Ward</span> <span style="color:#a6e22e">WardNumber</span> <span style="color:#e6db74">`json:&#34;ward&#34;`</span>
	<span style="color:#a6e22e">Age</span>  <span style="color:#a6e22e">Age</span>        <span style="color:#e6db74">`json:&#34;age&#34;`</span>
}

<span style="color:#75715e">// PatientTransferred event.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PatientTransferred</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span>            <span style="color:#a6e22e">ID</span>         <span style="color:#e6db74">`json:&#34;id&#34;`</span>
	<span style="color:#a6e22e">NewWardNumber</span> <span style="color:#a6e22e">WardNumber</span> <span style="color:#e6db74">`json:&#34;new_ward&#34;`</span>
}

<span style="color:#75715e">// PatientDischarged event.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PatientDischarged</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span> <span style="color:#a6e22e">ID</span> <span style="color:#e6db74">`json:&#34;id&#34;`</span>
}
</code></pre></div><p>Notice how the events are simply going structs which reference the id of the aggregate they&rsquo;re related to. There is also a marker interface that is implemented by them by way of a single un-exported method; this is to prevent outside structs from being flagged as possible events from this package and also to limit the scope of what counts as an event for this application.</p>
<p>Next, we turn to our aggregate, which looks like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">patient</span>

<span style="color:#75715e">// Patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Patient</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">id</span>         <span style="color:#a6e22e">ID</span>
	<span style="color:#a6e22e">ward</span>       <span style="color:#a6e22e">WardNumber</span>
	<span style="color:#a6e22e">name</span>       <span style="color:#a6e22e">Name</span>
	<span style="color:#a6e22e">age</span>        <span style="color:#a6e22e">Age</span>
	<span style="color:#a6e22e">discharged</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#a6e22e">changes</span> []<span style="color:#a6e22e">Event</span>
	<span style="color:#a6e22e">version</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">// NewFromEvents is a helper method that creates a new patient
</span><span style="color:#75715e">// from a series of events.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span> []<span style="color:#a6e22e">Event</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Patient</span>{}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">event</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">events</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">false</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">// Ward returns the patient&#39;s ward number.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Ward</span>() <span style="color:#a6e22e">WardNumber</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span>
}

<span style="color:#75715e">// Name returns the patient&#39;s name.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Name</span>() <span style="color:#a6e22e">Name</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">name</span>
}

<span style="color:#75715e">// Age returns the patient&#39;s age.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Age</span>() <span style="color:#a6e22e">Age</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span>
}

<span style="color:#75715e">// Discharged returns wether or not the patient has been discharged.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Discharged</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span>
}

<span style="color:#75715e">// ID returns the id of the patient. Duh.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">ID</span>() <span style="color:#a6e22e">ID</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>
}

<span style="color:#75715e">// New creates a new Patient from id, name, age and ward number.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">age</span> <span style="color:#a6e22e">Age</span>, <span style="color:#a6e22e">ward</span> <span style="color:#a6e22e">WardNumber</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Patient</span>{}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientAdmitted</span>{
		<span style="color:#a6e22e">ID</span>:   <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">Age</span>:  <span style="color:#a6e22e">age</span>,
		<span style="color:#a6e22e">Ward</span>: <span style="color:#a6e22e">ward</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">// Transfer transfers a patient to a new ward.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Transfer</span>(<span style="color:#a6e22e">newWard</span> <span style="color:#a6e22e">WardNumber</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPatientDischarged</span>
	}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientTransferred</span>{
		<span style="color:#a6e22e">ID</span>:            <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">NewWardNumber</span>: <span style="color:#a6e22e">newWard</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Discharge discharges a patient
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Discharge</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPatientDischarged</span>
	}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientDischarged</span>{
		<span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// On handles patient events on the patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">event</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientAdmitted</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ID</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Age</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Ward</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientDischarged</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> = <span style="color:#66d9ef">true</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientTransferred</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">NewWardNumber</span>

	}

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">new</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">version</span><span style="color:#f92672">++</span>
	}
}

<span style="color:#75715e">// Events returns the uncommitted events from the patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Events</span>() []<span style="color:#a6e22e">Event</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span>
}

<span style="color:#75715e">// Version returns the last version of the aggregate before changes.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Version</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">version</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">raise</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span> = append(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span>, <span style="color:#a6e22e">event</span>)
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">true</span>)
}
</code></pre></div><p>You&rsquo;ll notice a few things. First, the use of private fields in the aggregate is to protect our invariants. Then you&rsquo;ll notice that each method that raises an event does not change state directly, but instead raises an event first and that gets handled by the aggregate&rsquo;s <code>On</code> method. The <code>On</code> method is in charge of rebuilding the state from an event. It does a type switch on the event and caries out the behavior accordingly. Let&rsquo;s look at a single method closely.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Transfer transfers a patient to a new ward.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Transfer</span>(<span style="color:#a6e22e">newWard</span> <span style="color:#a6e22e">WardNumber</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPatientDischarged</span>
	}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientTransferred</span>{
		<span style="color:#a6e22e">ID</span>:            <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">NewWardNumber</span>: <span style="color:#a6e22e">newWard</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Notice how the <code>Transfer</code> method first checks if the patient has already been discharged before emitting the event. We first have to check the business rules are satisfied before emitting the appropriate event, otherwise, we reject the command and return an error. If all is well, we simply raise the event which gets handled by the <code>On</code> method and we return nil. We do not change state unless all of the conditions are satisfied.</p>
<p>Let&rsquo;s look at the <code>On</code> and <code>raise</code> methods more closely.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// On handles patient events on the patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">event</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientAdmitted</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ID</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Age</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Ward</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientDischarged</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> = <span style="color:#66d9ef">true</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientTransferred</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">NewWardNumber</span>

	}

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">new</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">version</span><span style="color:#f92672">++</span>
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">raise</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span> = append(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span>, <span style="color:#a6e22e">event</span>)
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">true</span>)
}
</code></pre></div><p>Notice, the On method first does a type switch on the event and selects the case for each event type. This is where state change happens. Once an event is emitted and saved we do not throw an error, we simply process the event and carry on. We can change here if we decide that an event is no longer relevant or if it means something different, but we can&rsquo;t return an error and say an event is invalid. Then we check if this is a new event if it isn&rsquo;t we increment the version number of our aggregate. The <code>raise</code> method does two things, it appends the event into our changes slice and calls the event handler <code>On</code> saying that this is a new event and we should not increment the version number. Wait, what&rsquo;s this about the version? The version is an optimistic concurrency pattern used to help us avoid database locks to change our aggregate.</p>
<p>So let&rsquo;s look at how we might use this aggregate. First, we have a repository that saves and retrieves the aggregate from the event store and we also have a service that represents a particular use case.</p>
<p>One method on the service might look like this. We first load up the aggregate by replaying the events, we execute the command and save it to the repository. Simple, no?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>) <span style="color:#a6e22e">TransferPatient</span>(
	<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,
	<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">ID</span>,
	<span style="color:#a6e22e">newWard</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">WardNumber</span>,
) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Transfer</span>(<span style="color:#a6e22e">newWard</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">Save</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">p</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Well, things aren&rsquo;t so simple for our repository implementation. Here, I&rsquo;ve come up with a way to save them to dynamodb using some helper libraries from a project called <a href="https://github.com/altairsix/eventsource">eventsource</a> by using embedded structs to serialize and deserialize the event objects to and from JSON. (The LINQ like syntax comes from a library called <a href="https://github.com/ahmetb/go-linq">go-linq</a>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">repository</span>) <span style="color:#a6e22e">Load</span>(
	<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,
	<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">ID</span>,
) (<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Patient</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// load up all events
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">records</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">String</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">events</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>{}
	<span style="color:#a6e22e">linq</span>.<span style="color:#a6e22e">From</span>(<span style="color:#a6e22e">records</span>).
		<span style="color:#a6e22e">SelectT</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">record</span> <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>) <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}

			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">typed</span> <span style="color:#66d9ef">struct</span> {
				<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
			}
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">typed</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}

			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">e</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">typed</span>.<span style="color:#a6e22e">Type</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmitted</span>{}):
				<span style="color:#a6e22e">e</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmitted</span>{}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransferred</span>{}):
				<span style="color:#a6e22e">e</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransferred</span>{}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>{}):
				<span style="color:#a6e22e">e</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>{}
			}

			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">e</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}

			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>
		}).
		<span style="color:#a6e22e">ToSlice</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">events</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">repository</span>) <span style="color:#a6e22e">Save</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Patient</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">records</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>, len(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Events</span>()))

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">linq</span>.<span style="color:#a6e22e">From</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Events</span>()).
		<span style="color:#a6e22e">SelectT</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>) <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span> {
			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">event</span>.(<span style="color:#66d9ef">type</span>) {
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmitted</span>:
				<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">admitted</span>{
					<span style="color:#a6e22e">Type</span>:           <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">e</span>),
					<span style="color:#a6e22e">PatientAdmitted</span>: <span style="color:#a6e22e">e</span>,
				})
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>:
				<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">discharged</span>{
					<span style="color:#a6e22e">Type</span>:              <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">e</span>),
					<span style="color:#a6e22e">PatientDischarged</span>: <span style="color:#a6e22e">e</span>,
				})
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransferred</span>:
				<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">transferred</span>{
					<span style="color:#a6e22e">Type</span>:              <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">e</span>),
					<span style="color:#a6e22e">PatientTransferred</span>: <span style="color:#a6e22e">e</span>,
				})
			}
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>{
				<span style="color:#a6e22e">Data</span>: <span style="color:#a6e22e">data</span>,
			}
		}).
		<span style="color:#a6e22e">ToSlice</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">records</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">records</span> {
		<span style="color:#a6e22e">expectedVersion</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Version</span>()
		<span style="color:#a6e22e">records</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Version</span> = <span style="color:#a6e22e">expectedVersion</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Save</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ID</span>().<span style="color:#a6e22e">String</span>(), <span style="color:#a6e22e">records</span><span style="color:#f92672">...</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">admitted</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmited</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">transferred</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransferred</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">discharged</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>) <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">event</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Kind</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Ptr</span> {
		<span style="color:#a6e22e">t</span> = <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Elem</span>()
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Name</span>()
}
</code></pre></div><p>In the <code>Save</code> method, you&rsquo;ll notice we extract the events from the aggregate, convert them to JSON and give them a version number, starting from the last version the aggregate was at. The version number is important for optimistic concurrency as we check before we save that there are no events with those versions before we save. If there are, we&rsquo;ve been beaten by another command handler and need to reject, because we are stale.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">records</span> {
		<span style="color:#a6e22e">expectedVersion</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Version</span>()
		<span style="color:#a6e22e">records</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Version</span> = <span style="color:#a6e22e">expectedVersion</span>
	}
</code></pre></div><p>When we load up the aggregate, we first load up all events in order and replay them back into the aggregate.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">repository</span>) <span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">id</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">ID</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Patient</span>, <span style="color:#66d9ef">error</span>) {
     <span style="color:#75715e">// load up all events
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">records</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">String</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">events</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>{}
	<span style="color:#a6e22e">linq</span>.<span style="color:#a6e22e">From</span>(<span style="color:#a6e22e">records</span>).
		<span style="color:#a6e22e">SelectT</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">record</span> <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>) <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span> {
            <span style="color:#75715e">// convert from record to domain event...
</span><span style="color:#75715e"></span>		}).
		<span style="color:#a6e22e">ToSlice</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">events</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

    <span style="color:#75715e">// Replay the events
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span>), <span style="color:#66d9ef">nil</span> 
}
</code></pre></div><p>In the aggregate&rsquo;s package, I&rsquo;ve chosen to have a helper method that replays all events for us.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// NewFromEvents is a helper method that creates a new patient
</span><span style="color:#75715e">// from a series of events.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span> []<span style="color:#a6e22e">Event</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Patient</span>{}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">event</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">events</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">false</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}
</code></pre></div><p>All this does is call our <code>On</code> method by passing false to the new flag.</p>
<p>With all that we now have an event sourced aggregate in Go. We didn&rsquo;t need a framework to do this, the go standard library was enough and I think you can figure out how to change or add what you need in the future.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Should you use event sourcing? That depends on your project and if the added complexity of adding event sourcing is warranted. I will say, that most simple applications don&rsquo;t, but that many will have some breakthroughs by applying this pattern. Let me hear your thoughts on this pattern. I&rsquo;ve seen incredible success with this pattern, especially in systems of various microservices where another microservice and get notifications of things that have happened in another by just reading the event stream of another service instead of asking them directly. So I see this going a lot of places and think I&rsquo;ll be doing this more in the future.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2341 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-03-23 21:13 -0400</p>
        </div>

        
            <div id="comments" class="thin">
                <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "vams" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
            <span>Victor A. MartÃ­nez Santiago</span>
            <span> <a href="https://victoramartinez.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js" integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-110221350-2', 'auto');
        ga('send', 'pageview');
    </script>



    </body>
</html>
