<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Victor A. Martinez">
<meta name="description" content="A personal bliki">
<meta name="generator" content="Hugo 0.66.0" />
<title>Event Sourcing in Go</title>
<link rel="shortcut icon" href="https://victoramartinez.com/images/favicon.ico">
<link rel="stylesheet" href="https://victoramartinez.com/css/style.css">
<link rel="stylesheet" href="https://victoramartinez.com/css/highlight.css">

<link rel="stylesheet" href="https://victoramartinez.com/css/override.css">



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">




<meta property="og:title" content="Event Sourcing in Go" />
<meta property="og:description" content="I&rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&rsquo;ve been doing it in Go and want to share how I do it.
To begin with I&rsquo;ve researched this topic thouraly. I&rsquo;ve probably watched and rewatched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://victoramartinez.com/posts/event-sourcing-in-go/" />
<meta property="article:published_time" content="2020-03-23T21:13:59-04:00" />
<meta property="article:modified_time" content="2020-03-23T21:13:59-04:00" />


<meta itemprop="name" content="Event Sourcing in Go">
<meta itemprop="description" content="I&rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&rsquo;ve been doing it in Go and want to share how I do it.
To begin with I&rsquo;ve researched this topic thouraly. I&rsquo;ve probably watched and rewatched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it.">
<meta itemprop="datePublished" content="2020-03-23T21:13:59-04:00" />
<meta itemprop="dateModified" content="2020-03-23T21:13:59-04:00" />
<meta itemprop="wordCount" content="2350">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Event Sourcing in Go"/>
<meta name="twitter:description" content="I&rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&rsquo;ve been doing it in Go and want to share how I do it.
To begin with I&rsquo;ve researched this topic thouraly. I&rsquo;ve probably watched and rewatched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it."/>
<meta name="twitter:site" content="@https://www.twitter.com/vectorhacker"/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='https://victoramartinez.com/'> <span class="arrow">‚Üê</span>Home</a>
	

	
 		<a href='/about/'>About Me</a>
  	

	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>Event Sourcing in Go</h1>
        <h2 class="subtitle"></h2>
        <h2 class="headline">
        March 23, 2020
        <br>
        
        </h2>
    </header>
    <section id="post-body">
        <p>I&rsquo;ve recently gone into doing CQRS with event sourcing along with DDD (Domain Driven Design) principles. I&rsquo;ve been doing it in Go and want to share how I do it.</p>
<p>To begin with I&rsquo;ve researched this topic thouraly. I&rsquo;ve probably watched and rewatched hundreds of videos and read many posts, articles, and books on it. I am by no means a cqrs/es expert, but I have gained some insight into how to do it. First thing I want to put out there is that you don&rsquo;t need a framework to do this. In fact, ddd and cqrs/es are best done without a framework getting in the way and instead you should create a <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Clean Architecture</a> where the framework you choose later on becomes a sort of plugin into your application.</p>
<p>So what is event sourcing? Simply put, event sourcing is a pattern by which current state is derived from previous facts (events). That is to say, to get the current state of an object you replay all the events of an object in memory to rebuild it from the actions you took previously. And you must accept these previous actions as fact, that is they already happened and you can&rsquo;t change it. You can change your mind about what a fact means to you in the future, but you can&rsquo;t change the fact or that it happened. New events are emmited when new actions are taken and that gets saved into the event store. The only unit of persitance in an event sourced application is the events, everything else is a projection of those events or more correctly a cache.</p>
<p>Events are emitted by aggregates who are composed of one or more entities. The repository for those aggregates are responsible for saving saving those events into the event store.</p>
<p>Where do these events come from? They come from the initial design of the system through various excercises such as event storming, a process by which the overall process or subprocesses of an application are discovered and modeled as events that have happened. Keep in mind, these aren&rsquo;t fine grained low-level events like you might be used to in GUI programming, such as a user clicked event, they&rsquo;re more coarse than that. Take the example of a system that deals with hospital admisions of a patient, let us model the interactions the patient has in the system with events. A patient might first be admited into the hospital, we might say we have a &ldquo;Patient Admited&rdquo; event; notice the past perfect tense. Later on, when a patient is transfered to another ward we say that we have a &ldquo;Patient Transfered&rdquo; event. Finally when a patient gets discharged we have &ldquo;Patient Discharged&rdquo;. These events arose out of the need to describe what has happened to a patient.</p>
<p>These events are created through the use of commands in the command query responsibilty segregation pattern. Commands signify intent that an action should be taken, but with no gaurantee that they will. A command handler has the ability to reject commands and produce no events. There are many ways to model commands in a system. They can be as simple as imperetive methods that tell an object what to do or as DTOs that have the data in them needed to carry out the command. In my case, I chose to make it as simple as a method on an object.</p>
<p>So with all this, what does it all look like in Go? To begin let&rsquo;s look at what an event might look like in Go. Let&rsquo;s use our patient example.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">patient</span>

<span style="color:#75715e">// Event is a domain event marker.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Event</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">isEvent</span>()
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">PatientAdmited</span>) <span style="color:#a6e22e">isEvent</span>()    {}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">PatientTransfered</span>) <span style="color:#a6e22e">isEvent</span>() {}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">PatientDischarged</span>) <span style="color:#a6e22e">isEvent</span>() {}

<span style="color:#75715e">// PatientAdmited event.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PatientAdmited</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span>   <span style="color:#a6e22e">ID</span>         <span style="color:#e6db74">`json:&#34;id&#34;`</span>
	<span style="color:#a6e22e">Name</span> <span style="color:#a6e22e">Name</span>       <span style="color:#e6db74">`json:&#34;name&#34;`</span>
	<span style="color:#a6e22e">Ward</span> <span style="color:#a6e22e">WardNumber</span> <span style="color:#e6db74">`json:&#34;ward&#34;`</span>
	<span style="color:#a6e22e">Age</span>  <span style="color:#a6e22e">Age</span>        <span style="color:#e6db74">`json:&#34;age&#34;`</span>
}

<span style="color:#75715e">// PatientTransfered event.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PatientTransfered</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span>            <span style="color:#a6e22e">ID</span>         <span style="color:#e6db74">`json:&#34;id&#34;`</span>
	<span style="color:#a6e22e">NewWardNumber</span> <span style="color:#a6e22e">WardNumber</span> <span style="color:#e6db74">`json:&#34;new_ward&#34;`</span>
}

<span style="color:#75715e">// PatientDischarged event.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PatientDischarged</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span> <span style="color:#a6e22e">ID</span> <span style="color:#e6db74">`json:&#34;id&#34;`</span>
}
</code></pre></div><p>Notice how the events are simply go structs which reference the id of the aggregate they&rsquo;re related to. There is also a marker interface that is implemented by them by way of a single unexported method; this is to prevent outside structs from being flaged as possible events from this package and also to limit the scope of what counts as an event for this application.</p>
<p>Next we turn to our aggregate, which looks like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">patient</span>

<span style="color:#75715e">// Patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Patient</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">id</span>         <span style="color:#a6e22e">ID</span>
	<span style="color:#a6e22e">ward</span>       <span style="color:#a6e22e">WardNumber</span>
	<span style="color:#a6e22e">name</span>       <span style="color:#a6e22e">Name</span>
	<span style="color:#a6e22e">age</span>        <span style="color:#a6e22e">Age</span>
	<span style="color:#a6e22e">discharged</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#a6e22e">changes</span> []<span style="color:#a6e22e">Event</span>
	<span style="color:#a6e22e">version</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">// NewFromEvents is a helper method that creates a new patient
</span><span style="color:#75715e">// from a series of events.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span> []<span style="color:#a6e22e">Event</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Patient</span>{}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">event</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">events</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">false</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">// Ward returns the patient&#39;s ward number.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Ward</span>() <span style="color:#a6e22e">WardNumber</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span>
}

<span style="color:#75715e">// Name returns the patient&#39;s name.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Name</span>() <span style="color:#a6e22e">Name</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">name</span>
}

<span style="color:#75715e">// Age returns the patient&#39;s age.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Age</span>() <span style="color:#a6e22e">Age</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span>
}

<span style="color:#75715e">// Discharged returns wether or not the patient has been discharged.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Discharged</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span>
}

<span style="color:#75715e">// ID returns the id of the patient. Duh.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">ID</span>() <span style="color:#a6e22e">ID</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>
}

<span style="color:#75715e">// New creates a new Patient from id, name, age and ward number.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">age</span> <span style="color:#a6e22e">Age</span>, <span style="color:#a6e22e">ward</span> <span style="color:#a6e22e">WardNumber</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Patient</span>{}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientAdmited</span>{
		<span style="color:#a6e22e">ID</span>:   <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">Age</span>:  <span style="color:#a6e22e">age</span>,
		<span style="color:#a6e22e">Ward</span>: <span style="color:#a6e22e">ward</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">// Transfer transfers a patient to a new ward.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Transfer</span>(<span style="color:#a6e22e">newWard</span> <span style="color:#a6e22e">WardNumber</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPatientDischarged</span>
	}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientTransfered</span>{
		<span style="color:#a6e22e">ID</span>:            <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">NewWardNumber</span>: <span style="color:#a6e22e">newWard</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Discharge discharges a patient
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Discharge</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPatientDischarged</span>
	}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientDischarged</span>{
		<span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// On handles patient events on the patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">event</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientAdmited</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ID</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Age</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Ward</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientDischarged</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> = <span style="color:#66d9ef">true</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientTransfered</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">NewWardNumber</span>

	}

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">new</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">version</span><span style="color:#f92672">++</span>
	}
}

<span style="color:#75715e">// Events returns the uncommited events from the patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Events</span>() []<span style="color:#a6e22e">Event</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span>
}

<span style="color:#75715e">// Version returns the last version of the aggregate before changes.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Version</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">version</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">raise</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span> = append(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span>, <span style="color:#a6e22e">event</span>)
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">true</span>)
}
</code></pre></div><p>You&rsquo;ll notice a few things. First the use of private fields in the aggregate, this is to protect our invariants. Then you&rsquo;ll notice that each method that raises an event does not change state directly, but instead raises an event first and that gets handled by the aggregate&rsquo;s <code>On</code> method. The <code>On</code> method is in charge of rebuilding the state from an event. It does a type switch on the event and caries out the behaviour accordingly. Let&rsquo;s look at a single method closely.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Transfer transfers a patient to a new ward.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">Transfer</span>(<span style="color:#a6e22e">newWard</span> <span style="color:#a6e22e">WardNumber</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPatientDischarged</span>
	}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">raise</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PatientTransfered</span>{
		<span style="color:#a6e22e">ID</span>:            <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">NewWardNumber</span>: <span style="color:#a6e22e">newWard</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Notice how the <code>Transfer</code> method first checks if the patient has already been discharged before emitting the event. We first have to check the business rules are satisfied before emitting the appropriate event, otherwise we reject the command and return an error. If all is well, we simply raise the event which gets handled by the <code>On</code> method and we return nil. We do not change state unless all of the conditions are satisfied.</p>
<p>Let&rsquo;s look at the <code>On</code> and <code>raise</code> methods more closely.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// On handles patient events on the patient aggregate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">event</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientAdmited</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ID</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Age</span>
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Ward</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientDischarged</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">discharged</span> = <span style="color:#66d9ef">true</span>

	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PatientTransfered</span>:
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ward</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">NewWardNumber</span>

	}

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">new</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">version</span><span style="color:#f92672">++</span>
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span>) <span style="color:#a6e22e">raise</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">Event</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span> = append(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">changes</span>, <span style="color:#a6e22e">event</span>)
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">true</span>)
}
</code></pre></div><p>Notice, the On method first does a type switch on the event and selects the case for each event type. This is where state change happends. Once an event is emited and saved we do not throw an error, we simply process the event and carry on. We can change here if we decide that an event is no longer relavant or if it means something different, but we can&rsquo;t return an error and say an event is invalid. Then we check if this is a new event, if it isn&rsquo;t we increment the version number of our aggregate. The <code>raise</code> method does two things, it appends the event into our changes slice and calls the event handler <code>On</code> saying that this is a new event and we should not increment the version number. Wait, what&rsquo;s this about the version? The version is an optimistic concurrency pattern used to help us avoid database locks in order to change our aggregate.</p>
<p>So let&rsquo;s look at how we might use this aggregate. First we have a repository that saves and retrives these&rsquo;s aggregate from the event store and we also have a service that represents a particular use case.</p>
<p>One method on the serivce might look like this. We first load up the aggregate by replaying the events, we execute the command, and save it to the repository. Simple, no?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>) <span style="color:#a6e22e">TransferPatient</span>(
	<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,
	<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">ID</span>,
	<span style="color:#a6e22e">newWard</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">WardNumber</span>,
) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Transfer</span>(<span style="color:#a6e22e">newWard</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">Save</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">p</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Well, things aren&rsquo;t so simple for our repository implementation. Here, I&rsquo;ve come up with a way to save them to dynamodb using some helper libraries from a project called <a href="https://github.com/altairsix/eventsource">eventsource</a> by using embeded structs to serialize and deserialize the event objects to and from json. (The LINQ like syntax comes from a library called <a href="https://github.com/ahmetb/go-linq">go-linq</a>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">repository</span>) <span style="color:#a6e22e">Load</span>(
	<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,
	<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">ID</span>,
) (<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Patient</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// load up all events
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">records</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">String</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">events</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>{}
	<span style="color:#a6e22e">linq</span>.<span style="color:#a6e22e">From</span>(<span style="color:#a6e22e">records</span>).
		<span style="color:#a6e22e">SelectT</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">record</span> <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>) <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}

			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">typed</span> <span style="color:#66d9ef">struct</span> {
				<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
			}
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">typed</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}

			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">e</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">typed</span>.<span style="color:#a6e22e">Type</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmited</span>{}):
				<span style="color:#a6e22e">e</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmited</span>{}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransfered</span>{}):
				<span style="color:#a6e22e">e</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransfered</span>{}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>{}):
				<span style="color:#a6e22e">e</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>{}
			}

			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">e</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}

			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>
		}).
		<span style="color:#a6e22e">ToSlice</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">events</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">repository</span>) <span style="color:#a6e22e">Save</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Patient</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">records</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>, len(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Events</span>()))

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">linq</span>.<span style="color:#a6e22e">From</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Events</span>()).
		<span style="color:#a6e22e">SelectT</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>) <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span> {
			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">event</span>.(<span style="color:#66d9ef">type</span>) {
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmited</span>:
				<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">admited</span>{
					<span style="color:#a6e22e">Type</span>:           <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">e</span>),
					<span style="color:#a6e22e">PatientAdmited</span>: <span style="color:#a6e22e">e</span>,
				})
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>:
				<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">discharged</span>{
					<span style="color:#a6e22e">Type</span>:              <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">e</span>),
					<span style="color:#a6e22e">PatientDischarged</span>: <span style="color:#a6e22e">e</span>,
				})
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransfered</span>:
				<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">transfered</span>{
					<span style="color:#a6e22e">Type</span>:              <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">e</span>),
					<span style="color:#a6e22e">PatientTransfered</span>: <span style="color:#a6e22e">e</span>,
				})
			}
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>{
				<span style="color:#a6e22e">Data</span>: <span style="color:#a6e22e">data</span>,
			}
		}).
		<span style="color:#a6e22e">ToSlice</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">records</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">records</span> {
		<span style="color:#a6e22e">expectedVersion</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Version</span>()
		<span style="color:#a6e22e">records</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Version</span> = <span style="color:#a6e22e">expectedVersion</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Save</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ID</span>().<span style="color:#a6e22e">String</span>(), <span style="color:#a6e22e">records</span><span style="color:#f92672">...</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">admited</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientAdmited</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">transfered</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientTransfered</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">discharged</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;event_type&#34;`</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">PatientDischarged</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">eventName</span>(<span style="color:#a6e22e">event</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>) <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">event</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Kind</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Ptr</span> {
		<span style="color:#a6e22e">t</span> = <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Elem</span>()
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Name</span>()
}
</code></pre></div><p>In the <code>Save</code> method, you&rsquo;ll notice we extact the events from the aggregate, conver them to json and give them a version number, starting from the last version the aggregate was at. The version number is important for optimistic concurrency as we check before we save that there are not events with those versions before we save. If there are, we&rsquo;ve been beaten by another command handler and need to reject, because we are stale.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">records</span> {
		<span style="color:#a6e22e">expectedVersion</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Version</span>()
		<span style="color:#a6e22e">records</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Version</span> = <span style="color:#a6e22e">expectedVersion</span>
	}
</code></pre></div><p>When we load up the aggregate, we first load up all events in order and replay them back into the aggregate.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">repository</span>) <span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">id</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">ID</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Patient</span>, <span style="color:#66d9ef">error</span>) {
     <span style="color:#75715e">// load up all events
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">records</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">String</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">events</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span>{}
	<span style="color:#a6e22e">linq</span>.<span style="color:#a6e22e">From</span>(<span style="color:#a6e22e">records</span>).
		<span style="color:#a6e22e">SelectT</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">record</span> <span style="color:#a6e22e">eventsource</span>.<span style="color:#a6e22e">Record</span>) <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">Event</span> {
            <span style="color:#75715e">// convert from record to domain event...
</span><span style="color:#75715e"></span>		}).
		<span style="color:#a6e22e">ToSlice</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">events</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

    <span style="color:#75715e">// Replay the events
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">patient</span>.<span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span>), <span style="color:#66d9ef">nil</span> 
}
</code></pre></div><p>In the aggregate&rsquo;s pacakge I&rsquo;ve chosen to have a helper method that replays all events for us.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// NewFromEvents is a helper method that creates a new patient
</span><span style="color:#75715e">// from a series of events.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFromEvents</span>(<span style="color:#a6e22e">events</span> []<span style="color:#a6e22e">Event</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Patient</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Patient</span>{}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">event</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">events</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">On</span>(<span style="color:#a6e22e">event</span>, <span style="color:#66d9ef">false</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}
</code></pre></div><p>All this does is call our <code>On</code> method by passing false to the new flag.</p>
<p>With all that we now have an event sourced aggregate in Go. We didn&rsquo;t need a framework to do this, the go standard library was enough and I think you can figure out how to change or add what you need in the future.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Should you use event sourcing? That depends on your project and if the added complexity of adding event sourcing is warrented. I will say, that most simple applications don&rsquo;t, but that many will have some breakthroughs by applying this pattern. Let me hear your thoughts on this pattern. I&rsquo;ve seen incredible success with this pattern, especially in systems of various microservices where another microservice and get notifications of things that have happend in another by just reading the event stream of another service instead of asking them directly. So I see this going a lot of places and think I&rsquo;ll be doing this more in the future.</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    <a href="https://twitter.com/vectorhacker">
    <img class="avatar" src="https://victoramartinez.com/images/avatar.png">
    <div>
        <span class="dark">Victor A. Martinez</span>
        <span>I&#39;m a software developer with opinions</span>
    </div>
    </a>
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fvictoramartinez.com%2fposts%2fevent-sourcing-in-go%2f - Event%20Sourcing%20in%20Go by @vectorhacker"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "vams" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="https://victoramartinez.com/posts/dont-use-frameworks/">Don&#39;t Use Frameworks<aside class="dates">Mar 24 2020</aside></a>
        </li>
    
        <li>
            <a href="https://victoramartinez.com/posts/learnings-working-large-software-project/">What I&#39;ve Learned Working in a Large Software Project<aside class="dates">Nov 28 2019</aside></a>
        </li>
    
        <li>
            <a href="https://victoramartinez.com/posts/wtf-is-blockchain/">WTF is Blockchain?<aside class="dates">Aug 7 2018</aside></a>
        </li>
    
        <li>
            <a href="https://victoramartinez.com/posts/goro/">Goro<aside class="dates">May 21 2018</aside></a>
        </li>
    
        <li>
            <a href="https://victoramartinez.com/posts/amazon-key/">Amazon Key<aside class="dates">Nov 26 2017</aside></a>
        </li>
    
        <li>
            <a href="https://victoramartinez.com/posts/github-pages/">Github Pages<aside class="dates">Nov 26 2017</aside></a>
        </li>
    
        <li>
            <a href="https://victoramartinez.com/posts/net-neutrality-opinion/">Net Neutrality Opinion<aside class="dates">Nov 26 2017</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="mailto:hello@victoramartinez.com">
        <i class="fa fa-envelope"></i>
    </a>
    
    <a class="symbol" href="https://www.github.com/vectorhacker">
        <i class="fa fa-github"></i>
    </a>
    
    <a class="symbol" href="https://www.reddit.com/user/vectorhacker/">
        <i class="fa fa-reddit"></i>
    </a>
    
    <a class="symbol" href="https://stackoverflow.com/users/2422918/victor-martinez">
        <i class="fa fa-stack-overflow"></i>
    </a>
    
    <a class="symbol" href="https://t.me/vectorhacker">
        <i class="fa fa-telegram"></i>
    </a>
    
    <a class="symbol" href="https://www.twitter.com/vectorhacker">
        <i class="fa fa-twitter"></i>
    </a>
    


</div>

    
    <p class="small">
    
        ¬© Copyright 2020 Victor A. Martinez
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://victoramartinez.com/js/main.js"></script>
<script src="https://victoramartinez.com/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-110221350-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
